on: [push, pull_request]

permissions:
  contents: read

jobs:
  smoke_test:
    runs-on: ubuntu-latest
    name: BoxLang Vanilla
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run local action
        uses: ./

      - name: Output installed BoxLang version
        run: boxlang --version

  test_with_version:
    runs-on: ubuntu-latest
    name: BoxLang with Specific Version
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run with Specific Version
        uses: ./
        with:
          version: "1.1.0"

      - name: Show Version
        run: boxlang --version

  test_with_modules:
    runs-on: ubuntu-latest
    name: BoxLang with Modules
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run with modules
        uses: ./
        with:
          modules: "bx-mail bx-compat-cfml"

      - name: Verify BoxLang installation
        run: boxlang --version

  test_skip_packages:
    runs-on: ubuntu-latest
    name: BoxLang Skip Package Installation
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Pre-install packages manually
        run: |
          sudo apt-get update
          sudo apt-get install -y curl zip unzip jq openjdk-21-jre

      - name: Run with skip package install
        uses: ./
        with:
          skip-package-install: true

      - name: Verify BoxLang installation
        run: boxlang --version

  test_latest_version:
    runs-on: ubuntu-latest
    name: BoxLang Latest Version
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run with latest version (explicit)
        uses: ./
        with:
          version: "latest"

      - name: Show Version
        run: boxlang --version

  test_snapshot_version:
    runs-on: ubuntu-latest
    name: BoxLang Snapshot Version
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run with snapshot version
        uses: ./
        with:
          version: "snapshot"

      - name: Show Version
        run: boxlang --version

  test_multiple_os:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    name: BoxLang on ${{ matrix.os }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run local action
        uses: ./

      - name: Verify installation
        run: boxlang --version

  test_outputs:
    runs-on: ubuntu-latest
    name: Test Action Outputs
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run local action
        id: setup-boxlang
        uses: ./

      - name: Display outputs
        run: |
          echo "BoxLang Version: ${{ steps.setup-boxlang.outputs.boxlang-version }}"
          echo "Installation Path: ${{ steps.setup-boxlang.outputs.installation-path }}"

  test_with_commandbox:
    runs-on: ubuntu-latest
    name: BoxLang with CommandBox
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run with CommandBox
        uses: ./
        with:
          with-commandbox: true

      - name: Verify BoxLang installation
        run: boxlang --version

      - name: Verify CommandBox installation
        run: box version

  test_with_commandbox_version:
    runs-on: ubuntu-latest
    name: BoxLang with specific CommandBox version
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run with CommandBox specific version
        uses: ./
        with:
          with-commandbox: true
          commandbox_version: "6.0.0"

      - name: Verify BoxLang installation
        run: boxlang --version

      - name: Verify CommandBox installation
        run: box version

  test_with_commandbox_modules:
    runs-on: ubuntu-latest
    name: BoxLang with CommandBox modules
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run with CommandBox and modules
        uses: ./
        with:
          with-commandbox: true
          commandbox_modules: "commandbox-dotenv"

      - name: Verify BoxLang installation
        run: boxlang --version

      - name: Verify CommandBox installation
        run: box version

      - name: Verify CommandBox modules
        run: box list --system

  test_with_forgebox_api_key:
    runs-on: ubuntu-latest
    name: BoxLang with ForgeBox API Key
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run with CommandBox and ForgeBox API Key
        uses: ./
        with:
          with-commandbox: true
          forgeboxAPIKey: "test-api-key"

      - name: Verify BoxLang installation
        run: boxlang --version

      - name: Verify CommandBox installation
        run: box version

      - name: Verify ForgeBox API Key is configured
        run: box config show endpoints.forgebox.APIToken

  test_custom_boxlang_home:
    runs-on: ubuntu-latest
    name: BoxLang with Custom Home Directory
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run with custom boxlang-home
        uses: ./
        with:
          boxlang-home: /tmp/custom-boxlang

      - name: Verify BoxLang installation
        run: boxlang --version

      - name: Verify BOXLANG_HOME is set correctly
        run: |
          echo "BOXLANG_HOME: $BOXLANG_HOME"
          if [[ "$BOXLANG_HOME" != "/tmp/custom-boxlang" ]]; then
            echo "BOXLANG_HOME is not set to the expected value"
            exit 1
          fi

      - name: Verify installation directory exists
        run: |
          if [[ ! -d "/tmp/custom-boxlang" ]]; then
            echo "Custom BoxLang home directory does not exist"
            exit 1
          fi
          echo "Custom BoxLang home directory exists: /tmp/custom-boxlang"

  test_default_boxlang_home:
    runs-on: ubuntu-latest
    name: BoxLang with Default Home Directory
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Run without custom boxlang-home (should default to workspace)
        uses: ./

      - name: Verify BoxLang installation
        run: boxlang --version

      - name: Verify BOXLANG_HOME is set to workspace
        run: |
          echo "BOXLANG_HOME: $BOXLANG_HOME"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          if [[ "$BOXLANG_HOME" != "$GITHUB_WORKSPACE/.boxlang" ]]; then
            echo "BOXLANG_HOME is not set to the expected default value"
            exit 1
          fi
          echo "BOXLANG_HOME is correctly set to workspace"

      - name: Verify default installation directory exists
        run: |
          if [[ ! -d "$GITHUB_WORKSPACE/.boxlang" ]]; then
            echo "Default BoxLang home directory does not exist"
            exit 1
          fi
          echo "Default BoxLang home directory exists in workspace"
